name: æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½

on:
  # å®šæ—¶å¤‡ä»½ï¼šæ¯å¤© 6ç‚¹ã€18ç‚¹æ‰§è¡Œ
  schedule:
    - cron: '0 6,18 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # åˆ†æ”¯æ¨é€æ—¶è§¦å‘å¤‡ä»½
  push:
    branches: [ main, master, develop, feature/*, hotfix/*, release/* ]
  # Pull Request æ—¶è§¦å‘å¤‡ä»½
  pull_request:
    branches: [ main, master, develop ]

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install sshpass & curl
        run: sudo apt-get update && sudo apt-get install -y sshpass curl

      - name: Get Event Info
        id: event_info
        run: |
          echo "event_name=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          echo "ref_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          
          # è·å–æäº¤ä¿¡æ¯
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "commit_message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
            echo "commit_author=${{ github.event.head_commit.author.name }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Backup Command on Remote Server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "
            # æµ‹è¯•æ•°æ®åº“è¿æ¥
            mysql -u${{ secrets.DATABASE_USERNAME }} -p'${{ secrets.DATABASE_PASSWORD }}' -e 'SELECT 1;' s1 || {
              echo 'Database connection test failed'
              exit 1
            }
            
            # æ‰§è¡Œå¤‡ä»½
            mysqldump -u${{ secrets.DATABASE_USERNAME }} -p'${{ secrets.DATABASE_PASSWORD }}' --single-transaction --routines --triggers s1 > ~/backup.sql &&
            gzip -f ~/backup.sql
          "

      - name: Copy Backup File
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:~/backup.sql.gz ./backup.sql.gz

      - name: Save, Limit to 1 Week Backups, and Commit
        run: |
          mkdir -p db_backups
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mv backup.sql.gz db_backups/backup_$TIMESTAMP.sql.gz
          # åªä¿ç•™è¿‘ä¸€å‘¨çš„å¤‡ä»½ï¼Œåˆ é™¤è¶…è¿‡7å¤©çš„å¤‡ä»½æ–‡ä»¶
          find db_backups -name "backup_*.sql.gz" -mtime +7 -delete

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add db_backups/backup_*.sql.gz
          
          # æ ¹æ®è§¦å‘æ–¹å¼ç”Ÿæˆä¸åŒçš„æäº¤ä¿¡æ¯
          if [ "${{ steps.event_info.outputs.event_name }}" = "schedule" ]; then
            COMMIT_MSG="ğŸ•’ å®šæ—¶å¤‡ä»½ at $TIMESTAMP"
          elif [ "${{ steps.event_info.outputs.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_MSG="ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘å¤‡ä»½ at $TIMESTAMP"
          elif [ "${{ steps.event_info.outputs.event_name }}" = "push" ]; then
            COMMIT_MSG="ğŸš€ åˆ†æ”¯æ¨é€è§¦å‘å¤‡ä»½ at $TIMESTAMP (åˆ†æ”¯: ${{ steps.event_info.outputs.ref_name }})"
          elif [ "${{ steps.event_info.outputs.event_name }}" = "pull_request" ]; then
            COMMIT_MSG="ğŸ”€ PRè§¦å‘å¤‡ä»½ at $TIMESTAMP (åˆ†æ”¯: ${{ steps.event_info.outputs.ref_name }})"
          else
            COMMIT_MSG="ğŸ“¦ è‡ªåŠ¨å¤‡ä»½ at $TIMESTAMP"
          fi
          
          git commit -m "$COMMIT_MSG" || echo "No changes"
          git push origin HEAD:${{ github.ref_name }}

      - name: Send Feishu Notification
        run: |
          # æ ¹æ®è§¦å‘æ–¹å¼ç”Ÿæˆä¸åŒçš„é€šçŸ¥æ¶ˆæ¯
          EVENT_NAME="${{ steps.event_info.outputs.event_name }}"
          REF_NAME="${{ steps.event_info.outputs.ref_name }}"
          ACTOR="${{ steps.event_info.outputs.actor }}"
          
          case $EVENT_NAME in
            "schedule")
              TRIGGER_INFO="â° å®šæ—¶å¤‡ä»½ï¼ˆæ¯å¤©6ç‚¹ã€18ç‚¹ï¼‰"
              ;;
            "workflow_dispatch")
              TRIGGER_INFO="ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘å¤‡ä»½"
              ;;
            "push")
              TRIGGER_INFO="ğŸš€ åˆ†æ”¯æ¨é€è§¦å‘å¤‡ä»½\nâ€¢ åˆ†æ”¯: $REF_NAME\nâ€¢ æäº¤è€…: $ACTOR"
              ;;
            "pull_request")
              TRIGGER_INFO="ğŸ”€ Pull Requestè§¦å‘å¤‡ä»½\nâ€¢ åˆ†æ”¯: $REF_NAME\nâ€¢ æäº¤è€…: $ACTOR"
              ;;
            *)
              TRIGGER_INFO="ğŸ“¦ è‡ªåŠ¨å¤‡ä»½"
              ;;
          esac
          
          curl -X POST ${{ secrets.FEISHU_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ğŸ‰ æ•°æ®åº“ s1 å¤‡ä»½æˆåŠŸï¼\n\nğŸ“Œ å¤‡ä»½ä¿¡æ¯ï¼š\nâ€¢ æ—¶é—´ï¼š'"$(date +'%Y-%m-%d %H:%M:%S')"'\nâ€¢ æœåŠ¡å™¨ï¼š${{ secrets.SERVER_HOST }}\nâ€¢ è§¦å‘æ–¹å¼ï¼š'"$TRIGGER_INFO"'\n\nâœ¨ å¤‡ä»½æ–‡ä»¶å·²ä¸Šä¼ è‡³ä»“åº“ db_backups ç›®å½•ã€‚\nğŸ“… å¤‡ä»½ç­–ç•¥ï¼šå®šæ—¶å¤‡ä»½ + ä»£ç æ¨é€è§¦å‘ï¼Œä¿ç•™è¿‘ä¸€å‘¨æ•°æ®ã€‚"
              }
            }'

      - name: Debug Info
        run: |
          echo "Event Name: ${{ steps.event_info.outputs.event_name }}"
          echo "Ref: ${{ steps.event_info.outputs.ref }}"
          echo "Ref Name: ${{ steps.event_info.outputs.ref_name }}"
          echo "Actor: ${{ steps.event_info.outputs.actor }}"
          echo "SHA: ${{ steps.event_info.outputs.sha }}"
